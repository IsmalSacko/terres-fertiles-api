<div class="stock-container container">
  <!--Bouton Ajouter un stock -->
  <div class="div-btn-ajout">
    <button mat-raised-button class="btn-ajout" color="primary" (click)="goToAddStock()">
      <mat-icon>add</mat-icon>
      Ajouter un stock
      </button>
  </div>

  <!-- KPIs Produits -->
 @if (!loadingProduits) {
  <div class="kpis">
    <mat-card class="kpi">
      <mat-card-header>
        <mat-icon>inventory_2</mat-icon>
        <mat-card-title>Volume total stocké </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="kpi-value">{{ formatNumber(totalVolumeStocke) }} m³</div>
      </mat-card-content>
    </mat-card>
    <mat-card class="kpi">
      <mat-card-header>
        <mat-icon>stacked_bar_chart</mat-icon>
        <mat-card-title>Volume total disponible </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="kpi-value">{{ formatNumber(totalVolumeMaturation) }} m³</div>
      </mat-card-content>
    </mat-card>
    <mat-card class="kpi">
      <mat-card-header>
        <mat-icon>shopping_cart</mat-icon>
        <mat-card-title>Volume total vendu </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="kpi-value">{{ formatNumber(totalVolumeVendu) }} m³</div>
      </mat-card-content>
    </mat-card>
  </div>
 }
 

  <!-- Graphiques -->
  <div class="charts">
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-icon>pie_chart</mat-icon>
        <mat-card-title>Répartition des volumes (m³)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <canvas #doughnutChart></canvas>
      </mat-card-content>
    </mat-card>

    <mat-card class="chart-card">
      <mat-card-header>
        <mat-icon>bar_chart</mat-icon>
        <mat-card-title>Top 10 des mélanges stockés (m³)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <canvas #barChart></canvas>
      </mat-card-content>
    </mat-card>

  <mat-card class="panel">
    <mat-card-header>
      <mat-icon>inventory</mat-icon>
      <mat-card-title>Dernières mises en stock</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      @if (loadingVentes) {
        <div class="loading-row">
          <mat-progress-spinner mode="indeterminate" diameter="36"></mat-progress-spinner>
          </div>
      }

      <table mat-table [dataSource]="stockages" class="mat-elevation-z1" >
        <ng-container matColumnDef="date_mise_en_stock">
          <th mat-header-cell *matHeaderCellDef> Date mise en stock </th>
          <td mat-cell *matCellDef="let v"> {{ formatDate(v.date_mise_en_stock) }} </td>
        </ng-container>
        <ng-container matColumnDef="melange">
          <th mat-header-cell *matHeaderCellDef> Mélange </th>
          <td mat-cell *matCellDef="let v"> {{ v.melange_nom || '—' }} </td>
        </ng-container>
        <ng-container matColumnDef="volume">
          <th mat-header-cell *matHeaderCellDef> Volume (m³) </th>
          <td mat-cell *matCellDef="let v"> {{ formatNumber(toNumber(v.volume)) }} </td>
        </ng-container>
        <ng-container matColumnDef="etat_stock">
          <th mat-header-cell *matHeaderCellDef> Statut </th>
          <td mat-cell *matCellDef="let v"> {{ v.etat_stock }} </td>
        </ng-container>
        <!--Boutons (modifier et supprimer)-->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Actions </th>
          <td mat-cell *matCellDef="let v">
            <button mat-icon-button  (click)="editStock(v.id)" class="text-primary me-2" style="border: 1px solid transparent;">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button  (click)="deleteStock(v.id)" class="text-danger" style="border: 1px solid transparent;">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['date_mise_en_stock','melange','volume','etat_stock','actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['date_mise_en_stock','melange','volume','etat_stock','actions']"></tr>
      </table>
    </mat-card-content>
  </mat-card>
</div>

<ng-template #loadingProduitsTpl>
  <div class="loading-center">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  </div>
</ng-template>
