<div class="stock-container container">
  <!-- KPIs Produits -->
  <div class="kpis" *ngIf="!loadingProduits; else loadingProduitsTpl">
    <mat-card class="kpi">
      <mat-card-header>
        <mat-icon>inventory_2</mat-icon>
        <mat-card-title>Volume initial (total produits)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="kpi-value">{{ formatNumber(totalVolumeInitial) }} m³</div>
      </mat-card-content>
    </mat-card>
    <mat-card class="kpi">
      <mat-card-header>
        <mat-icon>stacked_bar_chart</mat-icon>
        <mat-card-title>Volume disponible (total produits)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="kpi-value">{{ formatNumber(totalVolumeDisponible) }} m³</div>
      </mat-card-content>
    </mat-card>
    <mat-card class="kpi">
      <mat-card-header>
        <mat-icon>shopping_cart</mat-icon>
        <mat-card-title>Volume vendu (total produits)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="kpi-value">{{ formatNumber(totalVolumeVendu) }} m³</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Graphiques -->
  <div class="charts">
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-icon>pie_chart</mat-icon>
        <mat-card-title>Répartition des volumes (m³)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <canvas #doughnutChart></canvas>
      </mat-card-content>
    </mat-card>

    <mat-card class="chart-card">
      <mat-card-header>
        <mat-icon>bar_chart</mat-icon>
        <mat-card-title>Top 10 produits par stock disponible</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <canvas #barChart></canvas>
      </mat-card-content>
    </mat-card>

    <mat-card class="chart-card wide">
      <mat-card-header>
        <mat-icon>show_chart</mat-icon>
        <mat-card-title>Évolution des ventes (tonnes / mois)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <canvas #lineChart></canvas>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Liste produits -->
  <mat-card class="panel">
    <mat-card-header>
      <mat-icon>compost</mat-icon>
      <mat-card-title>Produits en vente</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="loadingProduits" class="loading-row">
        <mat-progress-spinner mode="indeterminate" diameter="36"></mat-progress-spinner>
      </div>
      <table mat-table [dataSource]="produits" class="mat-elevation-z1" *ngIf="!loadingProduits">
        <ng-container matColumnDef="reference_produit">
          <th mat-header-cell *matHeaderCellDef> Référence </th>
          <td mat-cell *matCellDef="let p"> {{ p.reference_produit }} </td>
        </ng-container>
        <ng-container matColumnDef="fournisseur">
          <th mat-header-cell *matHeaderCellDef> Fournisseur </th>
          <td mat-cell *matCellDef="let p"> {{ p.fournisseur }} </td>
        </ng-container>
        <ng-container matColumnDef="nom_site">
          <th mat-header-cell *matHeaderCellDef> Site </th>
          <td mat-cell *matCellDef="let p"> {{ p.nom_site }} </td>
        </ng-container>
        <ng-container matColumnDef="volume_initial">
          <th mat-header-cell *matHeaderCellDef> Initial (m³) </th>
          <td mat-cell *matCellDef="let p"> {{ formatNumber(toNumber(p.volume_initial)) }} </td>
        </ng-container>
        <ng-container matColumnDef="volume_disponible">
          <th mat-header-cell *matHeaderCellDef> Disponible (m³) </th>
          <td mat-cell *matCellDef="let p"> {{ formatNumber(toNumber(p.volume_disponible)) }} </td>
        </ng-container>
        <ng-container matColumnDef="volume_vendu">
          <th mat-header-cell *matHeaderCellDef> Vendu (m³) </th>
          <td mat-cell *matCellDef="let p"> {{ formatNumber(toNumber(p.volume_vendu)) }} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsProduits"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsProduits"></tr>
      </table>
    </mat-card-content>
  </mat-card>

  <!-- Liste ventes -->
  <mat-card class="panel">
    <mat-card-header>
      <mat-icon>receipt_long</mat-icon>
      <mat-card-title>Dernières ventes</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="loadingVentes" class="loading-row">
        <mat-progress-spinner mode="indeterminate" diameter="36"></mat-progress-spinner>
      </div>

      <table mat-table [dataSource]="ventes" class="mat-elevation-z1" *ngIf="!loadingVentes">
        <ng-container matColumnDef="date_vente">
          <th mat-header-cell *matHeaderCellDef> Date vente </th>
          <td mat-cell *matCellDef="let v"> {{ formatDate(v.date_vente) }} </td>
        </ng-container>
        <ng-container matColumnDef="nom_client">
          <th mat-header-cell *matHeaderCellDef> Client </th>
          <td mat-cell *matCellDef="let v"> {{ v.nom_client }} </td>
        </ng-container>
        <ng-container matColumnDef="produit">
          <th mat-header-cell *matHeaderCellDef> Produit </th>
          <td mat-cell *matCellDef="let v"> {{ v.produit?.reference_produit }} </td>
        </ng-container>
        <ng-container matColumnDef="volume_tonne">
          <th mat-header-cell *matHeaderCellDef> Volume (tonnes) </th>
          <td mat-cell *matCellDef="let v"> {{ v.volume_tonne }} </td>
        </ng-container>
        <ng-container matColumnDef="est_validee">
          <th mat-header-cell *matHeaderCellDef> Validée </th>
          <td mat-cell *matCellDef="let v"> {{ v.est_validee ? 'Oui' : 'Non' }} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsVentes"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsVentes"></tr>
      </table>
    </mat-card-content>
  </mat-card>
</div>

<ng-template #loadingProduitsTpl>
  <div class="loading-center">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  </div>
</ng-template>
