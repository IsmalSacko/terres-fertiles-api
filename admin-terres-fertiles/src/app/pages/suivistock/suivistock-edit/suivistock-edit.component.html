<div class="suivistock-edit-container">
  <!-- Loading spinner -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement des données...</p>
  </div>

  <!-- Contenu principal -->
  <div class="edit-content" *ngIf="!loading && suiviStock">
    
    <!-- En-tête -->
    <div class="header-section">
      <div class="title-section">
        <h1>
          <mat-icon>edit</mat-icon>
          Modifier le Suivi de Stock
        </h1>
        <p class="subtitle">Andain N° {{suiviStock.andain_numero}} - {{suiviStock.reference_suivi}}</p>
      </div>
      
      <div class="header-actions">
        <button mat-stroked-button (click)="onCancel()" [disabled]="saving">
          <mat-icon>close</mat-icon>
          Annuler
        </button>
        <button 
          mat-raised-button 
          color="primary" 
          (click)="onSubmit()"
          [disabled]="!isFormValid() || saving">
          <mat-spinner diameter="20" *ngIf="saving" class="saving-spinner"></mat-spinner>
          <mat-icon *ngIf="!saving">save</mat-icon>
          {{saving ? 'Enregistrement...' : 'Enregistrer'}}
        </button>
      </div>
    </div>

    <!-- Informations de calcul en temps réel -->
    <div class="calculation-info" *ngIf="volumesForm.valid">
      <mat-card class="calculation-card">
        <mat-card-content>
          <div class="calculation-metrics">
            <div class="calc-metric">
              <span class="label">Volume écoulé:</span>
              <span class="value">{{getVolumeEcoule()}} m³</span>
            </div>
            <div class="calc-metric">
              <span class="label">Taux d'écoulement:</span>
              <span class="value" [style.color]="getTauxEcoulement() >= 50 ? 'orange' : 'green'">
                {{getTauxEcoulement()}}%
              </span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Formulaire par étapes -->
    <mat-stepper [linear]="false" #stepper class="edit-stepper">
      
      <!-- Étape 1: Identification -->
      <mat-step [stepControl]="identificationForm" label="Identification">
        <form [formGroup]="identificationForm" class="step-form">
          
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Référence du suivi</mat-label>
              <input matInput formControlName="reference_suivi" placeholder="REF-001">
              <mat-error *ngIf="identificationForm.get('reference_suivi')?.hasError('required')">
                {{getFieldError(identificationForm, 'reference_suivi')}}
              </mat-error>
              <mat-error *ngIf="identificationForm.get('reference_suivi')?.hasError('maxlength')">
                {{getFieldError(identificationForm, 'reference_suivi')}}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Numéro d'andain</mat-label>
              <input matInput type="number" formControlName="andain_numero" placeholder="1">
              <mat-error *ngIf="identificationForm.get('andain_numero')?.hasError('required')">
                {{getFieldError(identificationForm, 'andain_numero')}}
              </mat-error>
              <mat-error *ngIf="identificationForm.get('andain_numero')?.hasError('min')">
                {{getFieldError(identificationForm, 'andain_numero')}}
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Plateforme</mat-label>
              <mat-select formControlName="plateforme">
                <mat-option *ngFor="let option of plateformeOptions" [value]="option.value">
                  {{option.label}}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="identificationForm.get('plateforme')?.hasError('required')">
                {{getFieldError(identificationForm, 'plateforme')}}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Mélange (optionnel)</mat-label>
              <mat-select formControlName="melange">
                <mat-option value="">Aucun</mat-option>
                <mat-option *ngFor="let option of melangeOptions" [value]="option.value">
                  {{option.label}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Statut</mat-label>
              <mat-select formControlName="statut">
                <mat-option *ngFor="let option of statutOptions" [value]="option.value">
                  {{option.label}}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="identificationForm.get('statut')?.hasError('required')">
                {{getFieldError(identificationForm, 'statut')}}
              </mat-error>
            </mat-form-field>
          </div>

          <div class="step-actions">
            <button mat-button matStepperNext [disabled]="!identificationForm.valid">
              Suivant
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Étape 2: Volumes -->
      <mat-step [stepControl]="volumesForm" label="Volumes">
        <form [formGroup]="volumesForm" class="step-form">
          
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Volume initial (m³)</mat-label>
              <input matInput type="number" step="0.01" formControlName="volume_initial_m3" placeholder="100.00">
              <mat-hint>Volume d'origine de l'andain</mat-hint>
              <mat-error *ngIf="volumesForm.get('volume_initial_m3')?.hasError('required')">
                {{getFieldError(volumesForm, 'volume_initial_m3')}}
              </mat-error>
              <mat-error *ngIf="volumesForm.get('volume_initial_m3')?.hasError('min')">
                {{getFieldError(volumesForm, 'volume_initial_m3')}}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Volume restant (m³)</mat-label>
              <input matInput type="number" step="0.01" formControlName="volume_restant_m3" placeholder="75.00">
              <mat-hint>Volume actuellement disponible</mat-hint>
              <mat-error *ngIf="volumesForm.get('volume_restant_m3')?.hasError('required')">
                {{getFieldError(volumesForm, 'volume_restant_m3')}}
              </mat-error>
              <mat-error *ngIf="volumesForm.get('volume_restant_m3')?.hasError('min')">
                {{getFieldError(volumesForm, 'volume_restant_m3')}}
              </mat-error>
              <mat-error *ngIf="volumesForm.get('volume_restant_m3')?.hasError('volumeRestantTropGrand')">
                {{getFieldError(volumesForm, 'volume_restant_m3')}}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Visualisation des volumes -->
          <div class="volume-visualization" *ngIf="volumesForm.valid">
            <div class="volume-bar">
              <div class="volume-initial" 
                   [style.width.%]="100">
                <span>Volume Initial: {{volumesForm.get('volume_initial_m3')?.value}} m³</span>
              </div>
              <div class="volume-ecoule" 
                   [style.width.%]="getTauxEcoulement()">
                <span *ngIf="getTauxEcoulement() > 10">Écoulé: {{getVolumeEcoule()}} m³</span>
              </div>
            </div>
            <div class="volume-legend">
              <div class="legend-item">
                <div class="legend-color initial"></div>
                <span>Volume Initial</span>
              </div>
              <div class="legend-item">
                <div class="legend-color ecoule"></div>
                <span>Volume Écoulé</span>
              </div>
              <div class="legend-item">
                <div class="legend-color restant"></div>
                <span>Volume Restant</span>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Précédent
            </button>
            <button mat-button matStepperNext [disabled]="!volumesForm.valid">
              Suivant
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Étape 3: Dates -->
      <mat-step [stepControl]="datesForm" label="Dates">
        <form [formGroup]="datesForm" class="step-form">
          
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Date mise en andains</mat-label>
              <input matInput [matDatepicker]="pickerAndains" formControlName="date_mise_en_andains">
              <mat-datepicker-toggle matIconSuffix [for]="pickerAndains"></mat-datepicker-toggle>
              <mat-datepicker #pickerAndains></mat-datepicker>
              <mat-hint>Date de création de l'andain</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Date mise en culture</mat-label>
              <input matInput [matDatepicker]="pickerCulture" formControlName="date_mise_en_culture">
              <mat-datepicker-toggle matIconSuffix [for]="pickerCulture"></mat-datepicker-toggle>
              <mat-datepicker #pickerCulture></mat-datepicker>
              <mat-hint>Date de début de maturation</mat-hint>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Date prévisionnelle vente</mat-label>
              <input matInput [matDatepicker]="pickerVente" formControlName="date_previsionnelle_vente">
              <mat-datepicker-toggle matIconSuffix [for]="pickerVente"></mat-datepicker-toggle>
              <mat-datepicker #pickerVente></mat-datepicker>
              <mat-hint>Date prévue pour la commercialisation</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Date d'écoulement</mat-label>
              <input matInput [matDatepicker]="pickerEcoulement" formControlName="date_ecoulement">
              <mat-datepicker-toggle matIconSuffix [for]="pickerEcoulement"></mat-datepicker-toggle>
              <mat-datepicker #pickerEcoulement></mat-datepicker>
              <mat-hint>Date d'écoulement complet</mat-hint>
            </mat-form-field>
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Précédent
            </button>
            <button mat-button matStepperNext>
              Suivant
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Étape 4: Informations complémentaires -->
      <mat-step [stepControl]="informationsForm" label="Informations">
        <form [formGroup]="informationsForm" class="step-form">
          
          <div class="form-row full-width">
            <mat-form-field appearance="outline">
              <mat-label>Recette</mat-label>
              <textarea matInput rows="4" formControlName="recette" 
                        placeholder="Détails de la composition et des proportions..."></textarea>
              <mat-hint>Description de la recette utilisée</mat-hint>
              <mat-error *ngIf="informationsForm.get('recette')?.hasError('maxlength')">
                {{getFieldError(informationsForm, 'recette')}}
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row full-width">
            <mat-form-field appearance="outline">
              <mat-label>Remarques</mat-label>
              <textarea matInput rows="4" formControlName="remarques" 
                        placeholder="Notes particulières, observations..."></textarea>
              <mat-hint>Informations complémentaires et observations</mat-hint>
              <mat-error *ngIf="informationsForm.get('remarques')?.hasError('maxlength')">
                {{getFieldError(informationsForm, 'remarques')}}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Champ utilisateur responsable masqué en édition -->
          <div class="form-row" style="display: none;">
            <mat-form-field appearance="outline">
              <mat-label>Utilisateur responsable</mat-label>
              <mat-select formControlName="utilisateur">
                <mat-option value="">Non défini</mat-option>
                <mat-option *ngFor="let option of utilisateurOptions" [value]="option.value">
                  {{option.label}}
                </mat-option>
              </mat-select>
              <mat-hint>Responsable du suivi</mat-hint>
            </mat-form-field>
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Précédent
            </button>
            <button 
              mat-raised-button 
              color="primary" 
              (click)="onSubmit()"
              [disabled]="!isFormValid() || saving">
              <mat-spinner diameter="20" *ngIf="saving" class="saving-spinner"></mat-spinner>
              <mat-icon *ngIf="!saving">save</mat-icon>
              {{saving ? 'Enregistrement...' : 'Enregistrer les modifications'}}
            </button>
          </div>
        </form>
      </mat-step>
    </mat-stepper>
  </div>

  <!-- Message si données non trouvées -->
  <div class="no-data-message" *ngIf="!loading && !suiviStock">
    <mat-icon>error</mat-icon>
    <h3>Suivi de stock non trouvé</h3>
    <p>Le suivi de stock à modifier n'existe pas ou n'est plus disponible.</p>
    <button mat-raised-button color="primary" routerLink="/suivistock">
      <mat-icon>arrow_back</mat-icon>
      Retour à la liste
    </button>
  </div>
</div>