<div class="suivistock-create-container">
  <!-- En-tête -->
  <div class="header-section">
    <div class="title-section">
      <h1>
        <mat-icon>add_circle</mat-icon>
        Nouveau Suivi de Stock
      </h1>
      <p class="subtitle">Créer un nouveau suivi d'andain sur plateforme</p>
    </div>
    
    <div class="action-buttons">
      <button mat-stroked-button (click)="onCancel()">
        <mat-icon>arrow_back</mat-icon>
        Retour à la liste
      </button>
    </div>
  </div>
  <!-- Loading spinner pour les données de référence -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement des données...</p>
  </div>

  <!-- Formulaire -->
  <div class="form-container" *ngIf="!loading">
    <form [formGroup]="createForm" (ngSubmit)="onSubmit()">
      
      <mat-stepper #stepper>
        
        <!-- Étape 1 : Identification -->
        <mat-step [stepControl]="createForm" label="Identification">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>inventory</mat-icon>
                Identification de l'andain
              </mat-card-title>
              <mat-card-subtitle>
                Informations de base pour identifier l'andain
              </mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="form-grid">
                
                <!-- Plateforme -->
                <mat-form-field appearance="outline" class="full-width info-form">
                  <mat-label>Plateforme *</mat-label>
                  <mat-select formControlName="plateforme">
                    <mat-option *ngFor="let plateforme of plateformes" [value]="plateforme.id">
                      {{plateforme.nom}} - {{plateforme.localisation}}
                    </mat-option>
                  </mat-select>
                  <mat-error>{{getErrorMessage('plateforme')}}</mat-error>
                  <mat-hint>Sélectionnez la plateforme où se trouve l'andain</mat-hint>
                </mat-form-field>

                <!-- Numéro d'andain -->
                <mat-form-field appearance="outline">
                  <mat-label>Numéro d'andain *</mat-label>
                  <input matInput type="number" formControlName="andain_numero" min="1">
                  <mat-error>{{getErrorMessage('andain_numero')}}</mat-error>
                  <mat-hint>Numéro unique de l'andain sur cette plateforme</mat-hint>
                </mat-form-field>

                <!-- Message de vérification andain -->
                <div class="andain-check-message" *ngIf="andainCheckMessage">
                  <mat-icon [color]="andainDisponible ? 'primary' : 'warn'">
                    {{andainDisponible ? 'check_circle' : 'error'}}
                  </mat-icon>
                  <span [class.error-message]="!andainDisponible" 
                        [class.success-message]="andainDisponible">
                    {{andainCheckMessage}}
                  </span>
                </div>

                <!-- Mélange -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Mélange</mat-label>
                  <mat-select formControlName="melange">
                    <mat-option value="">Aucun mélange</mat-option>
                    <mat-option *ngFor="let melange of melanges" [value]="melange.id">
                      {{melange.nom}} ({{melange.reference_produit}})
                    </mat-option>
                  </mat-select>
                  <mat-hint>Mélange associé à cet andain (optionnel)</mat-hint>
                </mat-form-field>
              </div>

              <!-- Résumé de sélection -->
              <div class="selection-summary" *ngIf="getSelectedPlateforme()">
                <h4>Résumé de la sélection</h4>
                <div class="summary-grid">
                  <div class="summary-item">
                    <strong>Plateforme:</strong>
                    <span>{{getSelectedPlateforme()?.nom}} - {{getSelectedPlateforme()?.localisation}}</span>
                  </div>
                  <div class="summary-item" *ngIf="getSelectedMelange()">
                    <strong>Mélange:</strong>
                    <span>{{getSelectedMelange()?.nom}}</span>
                  </div>
                </div>
              </div>
            </mat-card-content>
            
            <mat-card-actions>
              <button mat-raised-button color="primary" matStepperNext 
                      [disabled]="!createForm.get('plateforme')?.valid || 
                                  !createForm.get('andain_numero')?.valid || 
                                  !andainDisponible">
                Suivant
                <mat-icon>navigate_next</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </mat-step>

        <!-- Étape 2 : Volumes et Statut -->
        <mat-step [stepControl]="createForm" label="Volumes et Statut">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>straighten</mat-icon>
                Volumes et Statut
              </mat-card-title>
              <mat-card-subtitle>
                Définition des volumes et du statut initial
              </mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="form-grid info-form">
                
                <!-- Volume initial -->
                <mat-form-field appearance="outline">
                  <mat-label>Volume initial (m³) *</mat-label>
                  <input matInput type="number" formControlName="volume_initial_m3" 
                         min="0.1" step="0.1">
                  <mat-error>{{getErrorMessage('volume_initial_m3')}}</mat-error>
                  <mat-hint>Volume total de l'andain en mètres cubes</mat-hint>
                </mat-form-field>

                <!-- Volume restant -->
                <mat-form-field appearance="outline">
                  <mat-label>Volume restant (m³) *</mat-label>
                  <input matInput type="number" formControlName="volume_restant_m3" 
                         min="0" step="0.1">
                  <mat-error>{{getErrorMessage('volume_restant_m3')}}</mat-error>
                  <mat-hint>Volume actuellement disponible</mat-hint>
                </mat-form-field>

                <!-- Statut -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Statut *</mat-label>
                  <mat-select formControlName="statut">
                    <mat-option *ngFor="let statut of statutChoices" [value]="statut.value">
                      {{statut.label}}
                    </mat-option>
                  </mat-select>
                  <mat-error>{{getErrorMessage('statut')}}</mat-error>
                  <mat-hint>Statut actuel de l'andain</mat-hint>
                </mat-form-field>
              </div>

              <!-- Calculs automatiques -->
              <div class="calculations-display" *ngIf="createForm.get('volume_initial_m3')?.value">
                <h4>Calculs automatiques</h4>
                <div class="calc-grid">
                  <div class="calc-item">
                    <mat-icon>trending_down</mat-icon>
                    <div>
                      <strong>Volume écoulé</strong>
                      <span class="calc-value">{{getVolumeEcoule()}} m³</span>
                    </div>
                  </div>
                  <div class="calc-item">
                    <mat-icon>percent</mat-icon>
                    <div>
                      <strong>Taux d'écoulement</strong>
                      <span class="calc-value" 
                            [style.color]="getTauxEcoulement() >= 50 ? 'orange' : 'green'">
                        {{getTauxEcoulement()}}%
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </mat-card-content>
            
            <mat-card-actions>
              <button mat-button matStepperPrevious>
                <mat-icon>navigate_before</mat-icon>
                Précédent
              </button>
              <button mat-raised-button color="primary" matStepperNext
                      [disabled]="!createForm.get('volume_initial_m3')?.valid || 
                                  !createForm.get('volume_restant_m3')?.valid ||
                                  !createForm.get('statut')?.valid">
                Suivant
                <mat-icon>navigate_next</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </mat-step>

        <!-- Étape 3 : Dates -->
        <mat-step [stepControl]="createForm" label="Dates importantes">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>event</mat-icon>
                Dates importantes
              </mat-card-title>
              <mat-card-subtitle>
                Planification et suivi temporel
              </mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="form-grid info-form">
                
                <!-- Date mise en andains -->
                <mat-form-field appearance="outline">
                  <mat-label>Date mise en andains *</mat-label>
                  <input matInput [matDatepicker]="pickerAndains" 
                         formControlName="date_mise_en_andains">
                  <mat-datepicker-toggle matSuffix [for]="pickerAndains"></mat-datepicker-toggle>
                  <mat-datepicker #pickerAndains></mat-datepicker>
                  <mat-error>{{getErrorMessage('date_mise_en_andains')}}</mat-error>
                  <mat-hint>Date de formation de l'andain</mat-hint>
                </mat-form-field>

                <!-- Date mise en culture -->
                <mat-form-field appearance="outline">
                  <mat-label>Date mise en culture</mat-label>
                  <input matInput [matDatepicker]="pickerCulture" 
                         formControlName="date_mise_en_culture">
                  <mat-datepicker-toggle matSuffix [for]="pickerCulture"></mat-datepicker-toggle>
                  <mat-datepicker #pickerCulture></mat-datepicker>
                  <mat-hint>Date de début de culture (optionnel)</mat-hint>
                </mat-form-field>

                <!-- Date prévisionnelle vente -->
                <mat-form-field appearance="outline">
                  <mat-label>Date prévisionnelle vente</mat-label>
                  <input matInput [matDatepicker]="pickerVente" 
                         formControlName="date_previsionnelle_vente">
                  <mat-datepicker-toggle matSuffix [for]="pickerVente"></mat-datepicker-toggle>
                  <mat-datepicker #pickerVente></mat-datepicker>
                  <mat-hint>Date prévue pour la vente (optionnel)</mat-hint>
                </mat-form-field>

                <!-- Date écoulement -->
                <mat-form-field appearance="outline">
                  <mat-label>Date d'écoulement</mat-label>
                  <input matInput [matDatepicker]="pickerEcoulement" 
                         formControlName="date_ecoulement">
                  <mat-datepicker-toggle matSuffix [for]="pickerEcoulement"></mat-datepicker-toggle>
                  <mat-datepicker #pickerEcoulement></mat-datepicker>
                  <mat-hint>Date d'écoulement complet (optionnel)</mat-hint>
                </mat-form-field>
              </div>
            </mat-card-content>
            
            <mat-card-actions>
              <button mat-button matStepperPrevious>
                <mat-icon>navigate_before</mat-icon>
                Précédent
              </button>
              <button mat-raised-button color="primary" matStepperNext
                      [disabled]="!createForm.get('date_mise_en_andains')?.valid">
                Suivant
                <mat-icon>navigate_next</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </mat-step>

        <!-- Étape 4 : Informations techniques -->
        <mat-step [stepControl]="createForm" label="Informations techniques">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>science</mat-icon>
                Informations techniques
              </mat-card-title>
              <mat-card-subtitle>
                Recette et remarques additionnelles
              </mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="form-grid info-form">
                
                <!-- Recette -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Recette</mat-label>
                  <textarea matInput formControlName="recette" rows="4"
                            placeholder="Composition, proportions, instructions..."></textarea>
                  <mat-hint>Détails de la recette ou composition (optionnel)</mat-hint>
                </mat-form-field>

                <!-- Remarques -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Remarques</mat-label>
                  <textarea matInput formControlName="remarques" rows="4"
                            placeholder="Observations, notes particulières..."></textarea>
                  <mat-hint>Remarques et observations diverses (optionnel)</mat-hint>
                </mat-form-field>
              </div>

              <!-- Récapitulatif final -->
              <div class="final-summary">
                <h4>Récapitulatif</h4>
                <div class="summary-section">
                  <div class="summary-row">
                    <strong>Plateforme:</strong>
                    <span>{{getSelectedPlateforme()?.nom}}</span>
                  </div>
                  <div class="summary-row">
                    <strong>Andain N°:</strong>
                    <span>{{createForm.get('andain_numero')?.value}}</span>
                  </div>
                  <div class="summary-row" *ngIf="getSelectedMelange()">
                    <strong>Mélange:</strong>
                    <span>{{getSelectedMelange()?.nom}}</span>
                  </div>
                  <div class="summary-row">
                    <strong>Volume:</strong>
                    <span>{{createForm.get('volume_initial_m3')?.value}} m³ initial, 
                          {{createForm.get('volume_restant_m3')?.value}} m³ restant</span>
                  </div>
                  <div class="summary-row">
                    <strong>Statut:</strong>
                                      <div class="review-value">
                    <span>{{getStatutLabel(createForm.get('statut')?.value)}}</span>
                  </div>
                  </div>
                </div>
              </div>
            </mat-card-content>
            
            <mat-card-actions>
              <button mat-button matStepperPrevious>
                <mat-icon>navigate_before</mat-icon>
                Précédent
              </button>
              <button mat-raised-button color="primary" type="submit" 
                      [disabled]="!createForm.valid || !andainDisponible || saving">
                <mat-spinner diameter="20" *ngIf="saving"></mat-spinner>
                <mat-icon *ngIf="!saving">save</mat-icon>
                {{saving ? 'Création...' : 'Créer le suivi'}}
              </button>
            </mat-card-actions>
          </mat-card>
        </mat-step>
      </mat-stepper>
    </form>
  </div>

  <!-- Actions flottantes -->
  <div class="floating-actions">
    <button mat-button (click)="onCancel()" [disabled]="saving">
      <mat-icon>cancel</mat-icon>
      Annuler
    </button>
  </div>
</div>