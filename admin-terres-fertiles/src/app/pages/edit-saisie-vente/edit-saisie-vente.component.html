<div class="edit-saisie-vente-container mt-4">
  <mat-card class="edit-saisie-vente-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>edit</mat-icon>
        Modifier la saisie de vente
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Spinner de chargement -->
      @if (isLoading) {
        <div class="loading-container">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Chargement de la saisie de vente...</p>
        </div>
      }

      <!-- Formulaire -->
      @if (!isLoading) {
        <form [formGroup]="saisieVenteForm" (ngSubmit)="onSubmit()" class="saisie-form">
        <div class="form-grid">
          <!-- Nom du client -->
          <mat-form-field appearance="outline">
            <mat-label>Nom du client</mat-label>
            <input matInput formControlName="nom_client" placeholder="Nom du client">
            @if (nom_client?.hasError('required')) {
              <mat-error>
                Le nom du client est requis
              </mat-error>
            }
            @if (nom_client?.hasError('minlength')) {
              <mat-error>
                Le nom doit contenir au moins 2 caractères
              </mat-error>
            }
          </mat-form-field>

          <!-- Volume en tonnes -->
          <mat-form-field appearance="outline">
            <mat-label>Volume (tonnes)</mat-label>
            <input matInput type="number" formControlName="volume_tonne" 
                   placeholder="0.00" step="0.01" min="0.01">
            @if (volume_tonne?.hasError('required')) {
              <mat-error>
                Le volume est requis
              </mat-error>
            }
            @if (volume_tonne?.hasError('min')) {
              <mat-error>
                Le volume doit être supérieur à 0
              </mat-error>
            }
          </mat-form-field>

          <!-- Date de vente -->
          <mat-form-field appearance="outline">
            <mat-label>Date de vente</mat-label>
            <input matInput type="date" formControlName="date_vente">
            @if (date_vente?.hasError('required')) {
              <mat-error>
                La date de vente est requise
              </mat-error>
            }
          </mat-form-field>

          <!-- Produit -->
          <mat-form-field appearance="outline">
            <mat-label>Produit</mat-label>
            <mat-select formControlName="produit">
              @for (produit of produits; track produit.id) {
                <mat-option [value]="produit.id">
                  {{ produit.melange.nom || produit.reference_produit }} ({{ produit.volume_disponible }} tonnes disponibles)
                </mat-option>
              }
            </mat-select>
            @if (produit?.hasError('required')) {
              <mat-error>
                Le produit est requis
              </mat-error>
            }
          </mat-form-field>

          <!-- Nom du chantier récepteur -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nom du chantier récepteur</mat-label>
            <input matInput formControlName="nom_chantier_recepteur" placeholder="Nom du chantier">
            @if (nom_chantier_recepteur?.hasError('required')) {
              <mat-error>
                Le nom du chantier est requis
              </mat-error>
            }
            @if (nom_chantier_recepteur?.hasError('minlength')) {
              <mat-error>
                Le nom doit contenir au moins 2 caractères
              </mat-error>
            }
          </mat-form-field>

          <!-- Adresse du chantier -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Adresse du chantier</mat-label>
            <textarea matInput formControlName="adresse_chantier" 
                      placeholder="Adresse complète du chantier" rows="3"></textarea>
            @if (adresse_chantier?.hasError('required')) {
              <mat-error>
                L'adresse du chantier est requise
              </mat-error>
            }
            @if (adresse_chantier?.hasError('minlength')) {
              <mat-error>
                L'adresse doit contenir au moins 5 caractères
              </mat-error>
            }
          </mat-form-field>
        </div>

        <!-- Checkbox validation -->
        <div class="validation-section">
          <mat-checkbox formControlName="est_validee">
            <span class="validation-label">
              <mat-icon>verified</mat-icon>
              Saisie validée
            </span>
          </mat-checkbox>
        </div>

        <!-- Boutons d'action -->
        <div class="form-actions">
          <button mat-raised-button type="button" (click)="onCancel()" class="cancel-btn">
            <mat-icon>cancel</mat-icon>
            Annuler
          </button>
          <button mat-raised-button color="primary" type="submit" 
                  [disabled]="saisieVenteForm.invalid || isUpdating" class="submit-btn">
            @if (!isUpdating) {
              <mat-icon>save</mat-icon>
            }
            @if (isUpdating) {
              <mat-spinner diameter="20"></mat-spinner>
            }
            {{ isUpdating ? 'Modification...' : 'Modifier' }}
          </button>
        </div>
        </form>
      }
    </mat-card-content>
  </mat-card>
</div>
