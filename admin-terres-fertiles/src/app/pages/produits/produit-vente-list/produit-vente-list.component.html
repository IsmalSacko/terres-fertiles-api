<div class="standard-page-content">
<div class="produits-container">
  <!-- En-tête avec statistiques -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title">
        <mat-icon class="header-icon">inventory</mat-icon>
        <div class="title-text">
          <h1>Catalogue Produits</h1>
          <p>{{ totalItems }} produits disponibles à l'achat</p>
        </div>
      </div>
      <div class="header-stats">
        <div class="stat-card disponible">
          <mat-icon>check_circle</mat-icon>
          <div class="stat-info">
            <span class="stat-number">{{ getStatsCount('disponible') }}</span>
            <span class="stat-label">Disponibles</span>
          </div>
        </div>
        <div class="stat-card partiel">
          <mat-icon>pending</mat-icon>
          <div class="stat-info">
            <span class="stat-number">{{ getStatsCount('partiel') }}</span>
            <span class="stat-label">Partiels</span>
          </div>
        </div>
        <div class="stat-card vendu">
          <mat-icon>sold</mat-icon>
          <div class="stat-info">
            <span class="stat-number">{{ getStatsCount('vendu') }}</span>
            <span class="stat-label">Vendus</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barre de filtres et tri avancé -->
  <div class="filters-row">
    <!-- Recherche principale -->
    <mat-form-field class="search-field" appearance="outline">
      <mat-label>Recherche</mat-label>
      <input matInput
             [(ngModel)]="searchTerm"
             (keyup)="applyFilter()"
             placeholder="Référence, site, fournisseur...">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <!-- Filtre par statut -->
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Statut</mat-label>
      <mat-select [(ngModel)]="selectedStatut" (selectionChange)="applyFilter()">
        <mat-option value="">Tous</mat-option>
        <mat-option value="disponible">Disponible</mat-option>
        <mat-option value="partiel">Partiel</mat-option>
        <mat-option value="vendu">Vendu</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Filtre par plateforme -->
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Plateforme</mat-label>
      <mat-select [(ngModel)]="selectedPlateforme" (selectionChange)="applyFilter()">
        <mat-option value="">Toutes</mat-option>
        @for (plateforme of plateformes; track plateforme) {
          <mat-option [value]="plateforme">{{ plateforme }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <!-- Tri -->
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Tri par</mat-label>
      <mat-select [(ngModel)]="sortBy" (selectionChange)="applySorting()">
        <mat-option value="date_creation">Date</mat-option>
        <mat-option value="reference_produit">Référence</mat-option>
        <mat-option value="nom_site">Site</mat-option>
        <mat-option value="statut">Statut</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Direction du tri -->
    <mat-button-toggle-group [(ngModel)]="sortDirection" (change)="applySorting()" class="sort-direction">
      <mat-button-toggle value="asc">
        <mat-icon>arrow_upward</mat-icon>
      </mat-button-toggle>
      <mat-button-toggle value="desc">
        <mat-icon>arrow_downward</mat-icon>
      </mat-button-toggle>
    </mat-button-toggle-group>

    <!-- Options de vue -->
    <div class="view-controls">
      <mat-button-toggle-group [(ngModel)]="viewMode" (change)="onViewModeChange()">
        <mat-button-toggle value="cards">
          <mat-icon>view_module</mat-icon>
        </mat-button-toggle>
        <mat-button-toggle value="table">
          <mat-icon>view_list</mat-icon>
        </mat-button-toggle>
      </mat-button-toggle-group>
    </div>

    <!-- Bouton reset -->
    <button mat-stroked-button 
            class="reset-btn" 
            (click)="resetFilters()"
            matTooltip="Réinitialiser">
      <mat-icon>refresh</mat-icon>
    </button>
  </div>

  <!-- État de chargement -->
  @if (loading) {
    <div class="loading-state">
      <mat-spinner class="loading-spinner"></mat-spinner>
      <p>Chargement des produits...</p>
    </div>
  }

  <!-- Vue en cartes -->
  @if (!loading && viewMode === 'cards') {
    <div class="products-grid">
      @for (produit of filteredProduits; track produit.id) {
        <div class="product-card" [class]="'status-' + getStatutProduit(produit).toLowerCase().replace(' ', '-')">
          <!-- En-tête de la carte -->
          <div class="card-header">
            <div class="product-title">
              <h3>{{ produit.nom_site || produit.reference_produit }}</h3>
              <span class="status-badge" [style.background-color]="getStatutColor(produit)">
                {{ getStatutProduit(produit) }}
              </span>
            </div>
            <div class="product-ref">
              <mat-icon>tag</mat-icon>
              <span>{{ produit.reference_produit }}</span>
            </div>
          </div>

          <!-- Corps de la carte -->
          <div class="card-body">
            <!-- Volume principal -->
            <div class="volume-section">
              <div class="volume-main">
                <mat-icon class="volume-icon">inventory_2</mat-icon>
                <div class="volume-info">
                  <span class="volume-number">{{ (+produit.volume_disponible).toLocaleString() }}</span>
                  <span class="volume-unit">m³ disponibles à l'achat</span>
                </div>
              </div>
              @if (produit.volume_initial) {
                <div class="volume-details">
                  <div class="volume-bar">
                    <div class="volume-progress" 
                         [style.width.%]="getVolumePercentage(produit)">
                    </div>
                  </div>
                  <span class="volume-text">
                    {{ (+produit.volume_initial).toLocaleString() }} m³ initial
                  </span>
                </div>
              }
            </div>

            <!-- Informations détaillées -->
            <div class="product-details">
              @if (produit.chantier_info) {
                <div class="detail-item">
                  <mat-icon>construction</mat-icon>
                  <div class="detail-content">
                    <span class="detail-label">Chantier source</span>
                    <span class="detail-value">{{ produit.chantier_info.nom }}</span>
                    <span class="detail-location">{{ produit.chantier_info.localisation }}</span>
                  </div>
                </div>
              }

              @if (produit.plateforme) {
                <div class="detail-item">
                  <mat-icon>warehouse</mat-icon>
                  <div class="detail-content">
                    <span class="detail-label">Plateforme</span>
                    <span class="detail-value">{{ produit.plateforme.nom }}</span>
                    <span class="detail-location">{{ produit.plateforme.localisation }}</span>
                  </div>
                </div>
              }

              <div class="detail-item">
                <mat-icon>calendar_today</mat-icon>
                <div class="detail-content">
                  <span class="detail-label">Disponible le</span>
                  <span class="detail-value">{{ produit.date_disponibilite | date:'dd/MM/yyyy' }}</span>
                </div>
              </div>

              @if (produit.fournisseur) {
                <div class="detail-item">
                  <mat-icon>business</mat-icon>
                  <div class="detail-content">
                    <span class="detail-label">Fournisseur</span>
                    <span class="detail-value">{{ produit.fournisseur }}</span>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Actions -->
          <div class="card-actions">
            <button mat-button color="primary" [routerLink]="['/produits-vente', produit.id]">
              <mat-icon>visibility</mat-icon>
              Voir détails
            </button>
            <button 
              mat-stroked-button 
              color="accent" 
              [disabled]="getStatutProduit(produit) === 'Vendu'"
              (click)="openEmailForQuote(produit)"
              [title]="'Contacter le responsable: ' + (produit.utilisateur || 'contact@terres-fertiles.com')">
              <mat-icon>contact_mail</mat-icon>
              Demander un devis
            </button>
          </div>
        </div>
      }
    </div>
  }

  <!-- Vue en tableau -->
  @if (!loading && viewMode === 'table') {
    <div class="table-container">
      <table mat-table [dataSource]="filteredProduits" matSort (matSortChange)="sortTable($event)">
        <!-- Référence -->
        <ng-container matColumnDef="reference_produit">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Référence</th>
          <td mat-cell *matCellDef="let produit">{{ produit.reference_produit }}</td>
        </ng-container>

        <!-- Site -->
        <ng-container matColumnDef="nom_site">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Site</th>
          <td mat-cell *matCellDef="let produit">{{ produit.nom_site }}</td>
        </ng-container>

        <!-- Volume -->
        <ng-container matColumnDef="volume_disponible">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Volume disponible</th>
          <td mat-cell *matCellDef="let produit">
            <div class="volume-cell">
              <span class="volume-value">{{ (+produit.volume_disponible).toLocaleString() }} m³</span>
              @if (produit.volume_initial) {
                <div class="mini-progress">
                  <div class="mini-bar" [style.width.%]="getVolumePercentage(produit)"></div>
                </div>
              }
            </div>
          </td>
        </ng-container>

        <!-- Statut -->
        <ng-container matColumnDef="statut">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Statut</th>
          <td mat-cell *matCellDef="let produit">
            <mat-chip [style.background-color]="getStatutColor(produit)" [style.color]="'white'">
              {{ getStatutProduit(produit) }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Date -->
        <ng-container matColumnDef="date_disponibilite">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Date disponibilité</th>
          <td mat-cell *matCellDef="let produit">{{ produit.date_disponibilite | date:'dd/MM/yyyy' }}</td>
        </ng-container>

        <!-- Plateforme -->
        <ng-container matColumnDef="plateforme">
          <th mat-header-cell *matHeaderCellDef>Plateforme</th>
          <td mat-cell *matCellDef="let produit">{{ produit.plateforme?.nom }}</td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let produit">
            <button mat-icon-button [routerLink]="['/produits-vente', produit.id]" matTooltip="Voir détails">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button color="accent" 
                    [disabled]="getStatutProduit(produit) === 'Vendu'"
                    (click)="openEmailForQuote(produit)"
                    matTooltip="Demander un devis">
              <mat-icon>contact_mail</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>
  }

  <!-- État vide -->
  @if (!loading && filteredProduits.length === 0) {
    <div class="empty-state">
      <mat-icon>inventory</mat-icon>
      <h3>Aucun produit trouvé</h3>
      <p>Aucun produit ne correspond à vos critères de recherche</p>
      <button mat-button (click)="resetFilters()">
        <mat-icon>refresh</mat-icon>
        Réinitialiser les filtres
      </button>
    </div>
  }

  <!-- Pagination améliorée -->
  @if (!loading && filteredProduits.length > 0) {
    <div class="pagination-container">
      <!-- Informations sur les résultats -->
      <div class="pagination-info">
        <span class="results-count">
          {{ (currentPage * pageSize) + 1 }} - {{ Math.min((currentPage + 1) * pageSize, totalItems) }} 
          sur {{ totalItems }} produits
        </span>
      </div>

      <!-- Contrôles de pagination -->
      <div class="pagination-controls">
        <!-- Taille de page -->
        <div class="page-size-selector">
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>Afficher</mat-label>
            <mat-select [(ngModel)]="pageSize" (selectionChange)="onPageSizeChange()">
              <mat-option [value]="10">10</mat-option>
              <mat-option [value]="25">25</mat-option>
              <mat-option [value]="50">50</mat-option>
              <mat-option [value]="100">100</mat-option>
            </mat-select>
          </mat-form-field>
          <span class="page-size-label">par page</span>
        </div>

        <!-- Navigation -->
        <div class="page-navigation">
          <button mat-icon-button 
                  [disabled]="currentPage === 0"
                  (click)="goToPage(0)"
                  matTooltip="Première page">
            <mat-icon>first_page</mat-icon>
          </button>
          
          <button mat-icon-button 
                  [disabled]="currentPage === 0"
                  (click)="goToPage(currentPage - 1)"
                  matTooltip="Page précédente">
            <mat-icon>chevron_left</mat-icon>
          </button>

          <!-- Numéros de pages -->
          <div class="page-numbers">
            @for (page of getVisiblePages(); track page) {
              <button mat-button 
                      [class.current-page]="page === currentPage + 1"
                      (click)="goToPage(page - 1)"
                      class="page-number">
                {{ page }}
              </button>
            }
          </div>

          <button mat-icon-button 
                  [disabled]="currentPage >= getTotalPages() - 1"
                  (click)="goToPage(currentPage + 1)"
                  matTooltip="Page suivante">
            <mat-icon>chevron_right</mat-icon>
          </button>
          
          <button mat-icon-button 
                  [disabled]="currentPage >= getTotalPages() - 1"
                  (click)="goToPage(getTotalPages() - 1)"
                  matTooltip="Dernière page">
            <mat-icon>last_page</mat-icon>
          </button>
        </div>
      </div>
    </div>
  }
</div>
</div>
