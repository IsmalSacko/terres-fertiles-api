<div class="create-saisie-container mt-4">
  <mat-card class="form-card">
    <mat-card-header class="form-header">
      <mat-card-title>
        <mat-icon>add_business</mat-icon>
        Créer une nouvelle saisie de vente
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="saisieVenteForm" (ngSubmit)="onSubmit()" novalidate>
        
        <div class="form-grid">
          <!-- Colonne gauche -->
          <div class="form-column">
            <!-- Informations Client -->
            <div class="form-section">
              <h3 class="section-title">
                <mat-icon>person</mat-icon>
                Client
              </h3>
              
              <div class="form-row">
                <mat-form-field class="full-width">
                  <mat-label>Nom du client</mat-label>
                  <input matInput formControlName="nom_client" placeholder="Pierre GEORGES">
                  <mat-icon matSuffix>person</mat-icon>
                  @if (nom_client?.invalid && nom_client?.touched) {
                    <mat-error>
                      @if (nom_client?.errors?.['required']) {
                        <span>Requis</span>
                      }
                      @if (nom_client?.errors?.['minlength']) {
                        <span>Min 2 caractères</span>
                      }
                    </mat-error>
                  }
                </mat-form-field>
              </div>
            </div>

            <!-- Informations Produit -->
            <div class="form-section">

              <h3 class="section-title">
                <mat-icon>inventory_2</mat-icon>
                Produit
              </h3>

              <div class="form-row">
                <mat-form-field class="full-width">
                  <mat-label>Plateforme</mat-label>
                  <mat-select formControlName="plateforme">
                    @if (isLoading) {
                      <mat-option disabled>
                        Chargement des plateformes...
                      </mat-option>
                    }
                    @for (plateforme of plateformes; track plateforme.id) {
                      <mat-option [value]="plateforme.id">
                        {{ plateforme.nom }}
                      </mat-option>
                    }
                  </mat-select>
                  <mat-icon matSuffix>cloud</mat-icon>
                  @if (plateforme?.invalid && plateforme?.touched) {
                    <mat-error>Requis</mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field class="full-width">
                  <mat-label>Produit</mat-label>
                  <mat-select formControlName="produit">
                    @if (isLoading) {
                      <mat-option disabled>
                        Chargement des produits...
                      </mat-option>
                    }
                    @for (produit of produitsFiltres; track produit.id) {
                      <mat-option [value]="produit.id">
                        {{ produit.melange.nom || produit.reference_produit }} 
                        ({{ produit.volume_disponible }} tonnes disponibles)
                      </mat-option>
                    }
                  </mat-select>
                  <mat-icon matSuffix>inventory_2</mat-icon>
                  @if (produit?.invalid && produit?.touched) {
                    <mat-error>Requis</mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field class="full-width">
                  <mat-label>Volume (tonnes)</mat-label>
                  <input matInput type="number" step="0.01" formControlName="volume_tonne" placeholder="12.00">
                  <mat-icon matSuffix>scale</mat-icon>
                  @if (volume_tonne?.invalid && volume_tonne?.touched) {
                    <mat-error>
                      @if (volume_tonne?.errors?.['required']) {
                        <span>Requis</span>
                      }
                      @if (volume_tonne?.errors?.['min']) {
                        <span>Doit être > 0</span>
                      }
                    </mat-error>
                  }
                </mat-form-field>
              </div>
            </div>
          </div>

          <!-- Colonne droite -->
          <div class="form-column">
            <!-- Informations Vente -->
            <div class="form-section">
              <h3 class="section-title">
                <mat-icon>event</mat-icon>
                Vente
              </h3>
              
              <div class="form-row">
                <div class="date-field-wrapper">
                  <label for="date_vente" class="form-label">Date de vente *</label>
                  <input type="date" class="form-control form-control-lg" id="date_vente" formControlName="date_vente"
                         [class.is-invalid]="date_vente?.invalid && (date_vente?.dirty || date_vente?.touched)">
                  @if (date_vente?.invalid && (date_vente?.dirty || date_vente?.touched)) {
                    <div class="invalid-feedback">
                      La date de vente est requise.
                    </div>
                  }
                </div>
              </div>

              <div class="form-row">
                <mat-checkbox formControlName="est_validee" class="validation-checkbox">
                  Vente validée
                </mat-checkbox>
              </div>
            </div>

            <!-- Informations Chantier -->
            <div class="form-section">
              <h3 class="section-title">
                <mat-icon>location_on</mat-icon>
                Chantier
              </h3>
              
              <div class="form-row">
                <mat-form-field class="full-width">
                  <mat-label>Nom du chantier récepteur</mat-label>
                  <input matInput formControlName="nom_chantier_recepteur" placeholder="PHV">
                  <mat-icon matSuffix>business</mat-icon>
                  @if (nom_chantier_recepteur?.invalid && nom_chantier_recepteur?.touched) {
                    <mat-error>
                      @if (nom_chantier_recepteur?.errors?.['required']) {
                        <span>Requis</span>
                      }
                      @if (nom_chantier_recepteur?.errors?.['minlength']) {
                        <span>Min 2 caractères</span>
                      }
                    </mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field class="full-width">
                  <mat-label>Adresse du chantier</mat-label>
                  <input matInput type="text" formControlName="adresse_chantier"
                         [matAutocomplete]="autoAdresse" placeholder="18 Avenue Maurice Thorez">
                  <mat-icon matSuffix>place</mat-icon>
                  <mat-autocomplete #autoAdresse="matAutocomplete">
                    @for (option of filteredAdresses; track option) {
                      <mat-option [value]="option">
                        {{ option }}
                      </mat-option>
                    }
                  </mat-autocomplete>
                  @if (adresse_chantier?.invalid && adresse_chantier?.touched) {
                    <mat-error>
                      @if (adresse_chantier?.errors?.['required']) {
                        <span>Requis</span>
                      }
                      @if (adresse_chantier?.errors?.['minlength']) {
                        <span>Min 5 caractères</span>
                      }
                    </mat-error>
                  }
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <button mat-button type="button" (click)="onCancel()">
            <mat-icon>cancel</mat-icon>
            Annuler
          </button>
          
          <button mat-button type="button" (click)="resetForm()">
            <mat-icon>refresh</mat-icon>
            Réinitialiser
          </button>
          
          <button mat-raised-button color="primary" type="submit">
            @if (!isCreating && !isSuccess) {
              <mat-icon>save</mat-icon>
            }
            @if (isCreating) {
              <mat-icon class="spinning">hourglass_empty</mat-icon>
            }
            @if (isSuccess) {
              <mat-icon>check_circle</mat-icon>
            }
            {{ isCreating ? 'Création...' : isSuccess ? 'Création réussie !' : 'Créer la saisie' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
